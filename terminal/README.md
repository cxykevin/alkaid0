# Terminal æ¨¡å—

è¿™æ˜¯ä¸€ä¸ªpure-goå®ç°çš„è·¨å¹³å°ç»ˆç«¯ç³»ç»Ÿï¼ŒåŒ…å«ä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼š

## ç»„ä»¶

### 1. Sandbox - å‘½ä»¤æ‰§è¡Œæ²™ç›’ï¼ˆæ”¯æŒOSçº§éš”ç¦»ï¼‰

ä½äº [`terminal/sandbox`](terminal/sandbox/sandbox.go:1)

æä¾›å®‰å…¨çš„å‘½ä»¤æ‰§è¡Œç¯å¢ƒï¼Œæ”¯æŒä¸‰ç§éš”ç¦»æ¨¡å¼ï¼š

#### éš”ç¦»æ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | å®‰å…¨çº§åˆ« | æ€§èƒ½ |
|------|------|---------|------|
| **IsolationNone** | æ— éš”ç¦»ï¼ŒçœŸæœºè¿è¡Œ | âš ï¸ ä½ | âš¡ æœ€å¿« |
| **IsolationOS** | æ“ä½œç³»ç»Ÿçº§éš”ç¦» | âœ… é«˜ | ğŸ”„ ä¸­ç­‰ |
| **IsolationApp** | åº”ç”¨å±‚éš”ç¦»ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰ | âš ï¸ ä¸­ | âš¡ å¿« |

#### å¹³å°æ”¯æŒ

| å¹³å° | åº•å±‚éš”ç¦»å¼•æ“ | æ˜¯å¦éœ€root | é¢å¤–è½¯ä»¶åŒ… |
|------|-------------|-----------|-----------|
| **Linux** | user-namespaces + bind-mount | âŒ å¦ | util-linux (â‰¥2.27ï¼Œç³»ç»Ÿè‡ªå¸¦) |
| **macOS** | Apple sandbox-exec (Seatbelt) | âŒ å¦ | æ— ï¼ˆç³»ç»Ÿè‡ªå¸¦ï¼‰ |
| **Windows** | AppContainer + ACL | âŒ å¦ | appcontainer.exe (300KBï¼Œå¯é€‰) |

#### ç‰¹æ€§

- âœ… ç›®å½•è®¿é—®æ§åˆ¶ï¼ˆåªè¯»/è¯»å†™æƒé™ï¼‰
- âœ… å‘½ä»¤è¶…æ—¶æ§åˆ¶
- âœ… å·¥ä½œç›®å½•ç®¡ç†
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… å±é™©å‘½ä»¤éªŒè¯
- âœ… è·¨å¹³å°æ”¯æŒ
- âœ… ä¸‰ç§éš”ç¦»æ¨¡å¼å¯é€‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```go
import "github.com/cxykevin/alkaid0/terminal/sandbox"

// æ–¹å¼1ï¼šOSçº§éš”ç¦»ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
cfg := sandbox.Config{
    WritableDirs:  []string{"/tmp/myapp"},
    Timeout:       5 * time.Second,
    IsolationMode: sandbox.IsolationOS, // OSçº§éš”ç¦»
}
sb, err := sandbox.New(cfg)
if err != nil {
    log.Fatal(err)
}

// æ–¹å¼2ï¼šæ— éš”ç¦»ï¼ˆçœŸæœºè¿è¡Œï¼Œç”¨äºå¼€å‘/è°ƒè¯•ï¼‰
cfg := sandbox.Config{
    IsolationMode: sandbox.IsolationNone, // çœŸæœºè¿è¡Œ
}
sb, err := sandbox.New(cfg)

// æ‰§è¡Œå‘½ä»¤
cmd, err := sb.Execute("echo", "hello")
if err != nil {
    log.Fatal(err)
}

var stdout bytes.Buffer
cmd.SetStdout(&stdout)
if err := cmd.Run(); err != nil {
    log.Fatal(err)
}

fmt.Println(stdout.String())

// æ£€æŸ¥å¹³å°éš”ç¦»èƒ½åŠ›
info := sandbox.GetPlatformInfo()
fmt.Printf("å¹³å°: %s, éš”ç¦»èƒ½åŠ›: %s\n", info["os"], info["isolation"])
```

#### Linuxéš”ç¦»å®ç°

ä½¿ç”¨`unshare`åˆ›å»ºuser namespaceå’Œmount namespaceï¼š
- åˆ›å»ºç‹¬ç«‹çš„ç”¨æˆ·å‘½åç©ºé—´ï¼ˆæ— éœ€rootï¼‰
- æŒ‚è½½åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- ä¸ºæŒ‡å®šç›®å½•åˆ›å»ºå¯å†™bind mount
- éš”ç¦»PIDå‘½åç©ºé—´

#### macOSéš”ç¦»å®ç°

ä½¿ç”¨AppleåŸç”Ÿ`sandbox-exec`å’ŒSeatbelté…ç½®ï¼š
- åŸºäºSeatbeltç­–ç•¥è¯­è¨€
- é»˜è®¤æ‹’ç»æ‰€æœ‰æ“ä½œ
- å…è®¸è¯»å–ç³»ç»Ÿç›®å½•ï¼ˆ/usr, /System, /Libraryï¼‰
- å…è®¸è¯»å†™æŒ‡å®šç›®å½•

#### Windowséš”ç¦»å®ç°

ä½¿ç”¨AppContainerï¼ˆWindows 10/11ï¼‰ï¼š
- åˆ›å»ºä½æƒé™AppContainer
- é…ç½®æ–‡ä»¶ç³»ç»ŸACL
- éœ€è¦`appcontainer.exe`è¾…åŠ©å·¥å…·ï¼ˆå¯é€‰ï¼‰
- å¦‚æœå·¥å…·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨é™çº§åˆ°åº”ç”¨å±‚éš”ç¦»

### 2. PTY - ä¼ªç»ˆç«¯ä¸»æœº

ä½äº [`terminal/pty`](terminal/pty/pty.go:1)

Pure-goå®ç°çš„ä¼ªç»ˆç«¯ï¼Œä½¿ç”¨ç®¡é“æ¨¡æ‹ŸPTYè¡Œä¸ºï¼Œæ”¯æŒï¼š
- è·¨å¹³å°ï¼ˆWindows/Linux/macOSï¼‰
- æ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯æµ
- è¿›ç¨‹ç®¡ç†
- ç»ˆç«¯å¤§å°é…ç½®
- åŒå‘æ•°æ®ä¼ è¾“

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```go
import "github.com/cxykevin/alkaid0/terminal/pty"

// åˆ›å»ºPTY
cfg := pty.Config{
    Command: "bash",
    Rows:    24,
    Cols:    80,
}
p, err := pty.New(cfg)
if err != nil {
    log.Fatal(err)
}
defer p.Close()

// å¯åŠ¨
if err := p.Start(); err != nil {
    log.Fatal(err)
}

// å†™å…¥å‘½ä»¤
p.Write([]byte("ls -la\n"))

// è¯»å–è¾“å‡º
buf := make([]byte, 4096)
n, err := p.Read(buf)
if err != nil {
    log.Fatal(err)
}
fmt.Println(string(buf[:n]))
```

### 3. Buffer - VT/XTermåè®®ç¼“å†²åŒº

ä½äº [`terminal/buffer`](terminal/buffer/buffer.go:1)

å®ç°VT100/XTermè½¬ä¹‰åºåˆ—è§£æå’Œç»ˆç«¯ç¼“å†²åŒºç®¡ç†ï¼Œæ”¯æŒï¼š
- VT100/XTermè½¬ä¹‰åºåˆ—è§£æ
- ANSIé¢œè‰²æ”¯æŒï¼ˆ16è‰²ã€256è‰²ã€RGBï¼‰
- å…‰æ ‡æ§åˆ¶
- å±å¹•æ»šåŠ¨
- æ–‡æœ¬å±æ€§ï¼ˆç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ç­‰ï¼‰
- çº¿ç¨‹å®‰å…¨

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```go
import "github.com/cxykevin/alkaid0/terminal/buffer"

// åˆ›å»ºç¼“å†²åŒº
buf := buffer.New(24, 80) // 24è¡Œ x 80åˆ—

// å†™å…¥æ•°æ®ï¼ˆæ”¯æŒANSIè½¬ä¹‰åºåˆ—ï¼‰
buf.Write([]byte("\x1b[31mRed Text\x1b[0m\n"))
buf.Write([]byte("Normal Text\n"))

// è·å–å†…å®¹
content := buf.GetContent()
fmt.Println(content)

// è·å–ç‰¹å®šè¡Œ
line, err := buf.GetLine(0)
if err != nil {
    log.Fatal(err)
}
fmt.Println(line)

// å…‰æ ‡æ§åˆ¶
buf.SetCursor(10, 5)
x, y := buf.GetCursor()
fmt.Printf("å…‰æ ‡ä½ç½®: (%d, %d)\n", x, y)

// è°ƒæ•´å¤§å°
buf.Resize(30, 100)
```

## æ”¯æŒçš„ANSI/VTè½¬ä¹‰åºåˆ—

### å…‰æ ‡æ§åˆ¶
- `ESC[<n>A` - å…‰æ ‡ä¸Šç§»nè¡Œ
- `ESC[<n>B` - å…‰æ ‡ä¸‹ç§»nè¡Œ
- `ESC[<n>C` - å…‰æ ‡å³ç§»nåˆ—
- `ESC[<n>D` - å…‰æ ‡å·¦ç§»nåˆ—
- `ESC[<row>;<col>H` - è®¾ç½®å…‰æ ‡ä½ç½®
- `ESC[s` - ä¿å­˜å…‰æ ‡ä½ç½®
- `ESC[u` - æ¢å¤å…‰æ ‡ä½ç½®

### æ¸…é™¤æ“ä½œ
- `ESC[J` - æ¸…é™¤ä»å…‰æ ‡åˆ°å±å¹•æœ«å°¾
- `ESC[1J` - æ¸…é™¤ä»å±å¹•å¼€å§‹åˆ°å…‰æ ‡
- `ESC[2J` - æ¸…é™¤æ•´ä¸ªå±å¹•
- `ESC[K` - æ¸…é™¤ä»å…‰æ ‡åˆ°è¡Œå°¾
- `ESC[1K` - æ¸…é™¤ä»è¡Œé¦–åˆ°å…‰æ ‡
- `ESC[2K` - æ¸…é™¤æ•´è¡Œ

### æ–‡æœ¬å±æ€§ï¼ˆSGRï¼‰
- `ESC[0m` - é‡ç½®æ‰€æœ‰å±æ€§
- `ESC[1m` - ç²—ä½“
- `ESC[2m` - æš—æ·¡
- `ESC[3m` - æ–œä½“
- `ESC[4m` - ä¸‹åˆ’çº¿
- `ESC[5m` - é—ªçƒ
- `ESC[7m` - åè½¬
- `ESC[8m` - éšè—
- `ESC[9m` - åˆ é™¤çº¿

### é¢œè‰²
- `ESC[30-37m` - å‰æ™¯è‰²ï¼ˆæ ‡å‡†8è‰²ï¼‰
- `ESC[40-47m` - èƒŒæ™¯è‰²ï¼ˆæ ‡å‡†8è‰²ï¼‰
- `ESC[90-97m` - å‰æ™¯è‰²ï¼ˆé«˜äº®8è‰²ï¼‰
- `ESC[100-107m` - èƒŒæ™¯è‰²ï¼ˆé«˜äº®8è‰²ï¼‰
- `ESC[38;5;<n>m` - å‰æ™¯è‰²ï¼ˆ256è‰²ï¼‰
- `ESC[48;5;<n>m` - èƒŒæ™¯è‰²ï¼ˆ256è‰²ï¼‰
- `ESC[38;2;<r>;<g>;<b>m` - å‰æ™¯è‰²ï¼ˆRGBï¼‰
- `ESC[48;2;<r>;<g>;<b>m` - èƒŒæ™¯è‰²ï¼ˆRGBï¼‰

## æµ‹è¯•

æ¯ä¸ªç»„ä»¶éƒ½åŒ…å«å®Œæ•´çš„å•å…ƒæµ‹è¯•ï¼š

```bash
# æµ‹è¯•æ²™ç›’ï¼ˆåŸºç¡€æµ‹è¯•ï¼‰
go test ./terminal/sandbox -v

# æµ‹è¯•æ²™ç›’ï¼ˆåŒ…å«OSçº§éš”ç¦»æµ‹è¯•ï¼Œéœ€è¦ç›¸åº”å·¥å…·ï¼‰
RUN_ISOLATION_TESTS=1 go test ./terminal/sandbox -v

# æµ‹è¯•PTY
go test ./terminal/pty -v

# æµ‹è¯•ç¼“å†²åŒº
go test ./terminal/buffer -v

# æµ‹è¯•æ‰€æœ‰ç»„ä»¶
go test ./terminal/... -v
```

## å¹³å°æ”¯æŒ

- âœ… Linuxï¼ˆæ¨èï¼Œå®Œæ•´æ”¯æŒuser-namespaceséš”ç¦»ï¼‰
- âœ… macOSï¼ˆå®Œæ•´æ”¯æŒsandbox-execéš”ç¦»ï¼‰
- âœ… Windowsï¼ˆæ”¯æŒAppContaineréš”ç¦»ï¼Œéœ€è¦é¢å¤–å·¥å…·ï¼‰

## ç‰¹æ€§

### è·¨å¹³å°
æ‰€æœ‰ç»„ä»¶éƒ½ä½¿ç”¨pure-goå®ç°ï¼Œæ— éœ€CGOï¼Œå¯åœ¨æ‰€æœ‰Goæ”¯æŒçš„å¹³å°ä¸Šè¿è¡Œã€‚

### çº¿ç¨‹å®‰å…¨
Bufferç»„ä»¶ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤ï¼Œæ”¯æŒå¹¶å‘è¯»å†™ã€‚

### å®‰å…¨æ€§
- **OSçº§éš”ç¦»**ï¼šä½¿ç”¨æ“ä½œç³»ç»ŸåŸç”Ÿéš”ç¦»æœºåˆ¶ï¼Œæä¾›æœ€é«˜å®‰å…¨æ€§
- **åº”ç”¨å±‚éš”ç¦»**ï¼šç›®å½•è®¿é—®æ§åˆ¶å’Œå‘½ä»¤éªŒè¯
- **æ— éš”ç¦»æ¨¡å¼**ï¼šç”¨äºå¼€å‘å’Œè°ƒè¯•ï¼Œæ€§èƒ½æœ€ä¼˜

### æ€§èƒ½
- é«˜æ•ˆçš„ç¼“å†²åŒºç®¡ç†
- æœ€å°åŒ–å†…å­˜åˆ†é…
- æ”¯æŒå¤§é‡å¹¶å‘æ“ä½œ
- å¯é€‰çš„éš”ç¦»çº§åˆ«ä»¥å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½

## ä½¿ç”¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒ
```go
cfg := sandbox.Config{
    WritableDirs:  []string{"/app/data", "/tmp"},
    Timeout:       30 * time.Second,
    IsolationMode: sandbox.IsolationOS, // ä½¿ç”¨OSçº§éš”ç¦»
}
```

### å¼€å‘ç¯å¢ƒ
```go
cfg := sandbox.Config{
    IsolationMode: sandbox.IsolationNone, // æ— éš”ç¦»ï¼Œä¾¿äºè°ƒè¯•
}
```

### å…¼å®¹æ¨¡å¼
```go
cfg := sandbox.Config{
    WritableDirs:  []string{"/tmp"},
    IsolationMode: sandbox.IsolationApp, // åº”ç”¨å±‚éš”ç¦»
}
```

## é™åˆ¶

1. **PTYå®ç°**ï¼šç”±äºæ˜¯pure-goå®ç°ï¼Œä½¿ç”¨ç®¡é“æ¨¡æ‹ŸPTYè¡Œä¸ºï¼ŒæŸäº›é«˜çº§PTYç‰¹æ€§ï¼ˆå¦‚çª—å£å¤§å°ä¿¡å·ï¼‰å¯èƒ½æ— æ³•å®Œå…¨æ¨¡æ‹Ÿã€‚

2. **Linuxéš”ç¦»**ï¼šéœ€è¦util-linux â‰¥2.27ï¼ˆé€šå¸¸ç³»ç»Ÿå·²è‡ªå¸¦ï¼‰ï¼Œå†…æ ¸éœ€æ”¯æŒuser namespacesã€‚

3. **macOSéš”ç¦»**ï¼šéœ€è¦macOS 10.5+ï¼ˆç³»ç»Ÿè‡ªå¸¦sandbox-execï¼‰ã€‚

4. **Windowséš”ç¦»**ï¼šéœ€è¦Windows 10/11ï¼Œå¯é€‰appcontainer.exeå·¥å…·ï¼ˆå¦‚æ— åˆ™é™çº§åˆ°åº”ç”¨å±‚éš”ç¦»ï¼‰ã€‚

5. **è½¬ä¹‰åºåˆ—**ï¼šç›®å‰æ”¯æŒå¸¸ç”¨çš„VT100/XTermåºåˆ—ï¼ŒæŸäº›é«˜çº§æˆ–ä¸å¸¸ç”¨çš„åºåˆ—å¯èƒ½æœªå®ç°ã€‚

## å®‰å…¨æ³¨æ„äº‹é¡¹

- **IsolationNoneæ¨¡å¼**ï¼šå‘½ä»¤ç›´æ¥åœ¨çœŸæœºè¿è¡Œï¼Œä»…ç”¨äºå¼€å‘/è°ƒè¯•ç¯å¢ƒ
- **IsolationOSæ¨¡å¼**ï¼šæä¾›æœ€é«˜å®‰å…¨æ€§ï¼Œæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ
- **IsolationAppæ¨¡å¼**ï¼šåº”ç”¨å±‚æ§åˆ¶ï¼Œå®‰å…¨æ€§ä¸­ç­‰ï¼Œç”¨äºå…¼å®¹æ€§åœºæ™¯
- å§‹ç»ˆéªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œé¿å…å‘½ä»¤æ³¨å…¥
- å®šæœŸæ›´æ–°å¯å†™ç›®å½•ç™½åå•
- ç›‘æ§å‘½ä»¤æ‰§è¡Œæ—¥å¿—

## æ€§èƒ½å¯¹æ¯”

| éš”ç¦»æ¨¡å¼ | å¯åŠ¨å¼€é”€ | è¿è¡Œå¼€é”€ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| IsolationNone | ~0ms | 0% | å¼€å‘/è°ƒè¯• |
| IsolationApp | ~1ms | <1% | å…¼å®¹æ€§è¦æ±‚é«˜ |
| IsolationOS | ~10-50ms | 1-5% | ç”Ÿäº§ç¯å¢ƒ |

## æœªæ¥æ”¹è¿›

- [ ] æ”¯æŒæ›´å¤šVT/XTermè½¬ä¹‰åºåˆ—
- [ ] æ·»åŠ å†å²è®°å½•åŠŸèƒ½
- [ ] æ”¯æŒé¼ æ ‡äº‹ä»¶
- [ ] ä¼˜åŒ–å¤§æ–‡ä»¶è¾“å‡ºæ€§èƒ½
- [ ] æ·»åŠ æ›´å¤šå®‰å…¨ç­–ç•¥é€‰é¡¹
- [ ] æ”¯æŒcgroupèµ„æºé™åˆ¶ï¼ˆLinuxï¼‰
- [ ] æ”¹è¿›Windows AppContaineré›†æˆ

## è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ç›¸åŒ
